<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MetaMask SDK - Android Chrome Sepolia Test</title>

    <!-- MetaMask SDK (Pure JS / CDN) -->
    <script src="https://c0f4f41c-2f55-4863-921b-sdk-docs.github.io/cdn/metamask-sdk.js"></script>

    <!-- Ethers v6 UMD (for easy ABI encoding/decoding) -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
  </head>

  <body>
    <button id="connect">Connect MetaMask</button>
    <button id="read" disabled>Read ETH/USD (Sepolia)</button>
    <pre id="log"></pre>

    <script>
      const INFURA_KEY = "PASTE_YOUR_INFURA_KEY_HERE";

      const logEl = document.getElementById("log");
      const btnConnect = document.getElementById("connect");
      const btnRead = document.getElementById("read");

      function log(...args) {
        logEl.textContent += args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ") + "\n";
      }

      function isAndroid() {
        return /Android/i.test(navigator.userAgent);
      }

      // Force MetaMask to foreground on Android Chrome by targeting the app package directly.
      function androidIntentWrap(link) {
        try {
          const u = new URL(link);
          const scheme = u.protocol.replace(":", ""); // https
          return `intent://${u.host}${u.pathname}${u.search}${u.hash}#Intent;scheme=${scheme};package=io.metamask;end`;
        } catch (e) {
          return link;
        }
      }

      const MMSDK = new MetaMaskSDK.MetaMaskSDK({
        dappMetadata: {
          name: "Bare MetaMask SDK Sepolia Test",
          url: window.location.href,
        },
        infuraAPIKey: "2e4efadf229d4718933748e0fb680f17",

        // The important part for your specific Android Chrome behavior:
        openDeeplink: (link) => {
          const target = isAndroid() ? androidIntentWrap(link) : link;
          window.location.href = target;
        },
      });

      const provider = MMSDK.getProvider();

      const SEPOLIA_CHAIN_ID = "0xaa36a7"; // 11155111
      const FEED_ETH_USD_SEPOLIA = "0x694AA1769357215DE4FAC081bf1f309aDC325306"; // Chainlink ETH/USD (Sepolia)
      // Source: Chainlink docs list this Sepolia ETH/USD address. :contentReference[oaicite:3]{index=3}

      const FEED_ABI = [
        "function decimals() view returns (uint8)",
        "function latestRoundData() view returns (uint80 roundId,int256 answer,uint256 startedAt,uint256 updatedAt,uint80 answeredInRound)"
      ];

      async function ensureSepolia() {
        const chainId = await provider.request({ method: "eth_chainId" });
        if (chainId === SEPOLIA_CHAIN_ID) return;

        try {
          await provider.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: SEPOLIA_CHAIN_ID }],
          });
        } catch (err) {
          log("Switch chain failed:", err?.message || err);
          throw err;
        }
      }

      btnConnect.onclick = async () => {
        try {
          log("Connecting...");
          const accounts = await MMSDK.connect();
          log("Connected:", accounts[0]);

          const chainId = await provider.request({ method: "eth_chainId" });
          log("chainId:", chainId);

          btnRead.disabled = false;
        } catch (e) {
          log("Connect error:", e?.message || e);
        }
      };

      btnRead.onclick = async () => {
        try {
          await ensureSepolia();

          const browserProvider = new ethers.BrowserProvider(provider);
          const feed = new ethers.Contract(FEED_ETH_USD_SEPOLIA, FEED_ABI, browserProvider);

          const decimals = await feed.decimals();
          const data = await feed.latestRoundData();

          // data.answer is int256; ethers v6 returns bigint-like values for ints
          const price = ethers.formatUnits(data.answer, decimals);

          log("ETH/USD (Sepolia):", price);
          log("updatedAt:", data.updatedAt.toString());
        } catch (e) {
          log("Read error:", e?.message || e);
        }
      };
    </script>
  </body>
</html>


