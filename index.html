<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MetaMask SDK Bare Demo (Sepolia)</title>
  </head>

  <body>
    <button id="connect">Connect MetaMask</button>
    <button id="call" disabled>Sepolia: ETH/USD latestRoundData()</button>
    <pre id="log"></pre>

    <!-- Use the MetaMask docs CDN build (pure JS / no bundler) -->
    <script src="https://c0f4f41c-2f55-4863-921b-sdk-docs.github.io/cdn/metamask-sdk.js"></script>

    <script>
      const INFURA_KEY = "PASTE_YOUR_INFURA_KEY_HERE";

      const SEPOLIA_CHAIN_ID = "0xaa36a7";
      const SEPOLIA_RPC = "https://sepolia.infura.io/v3/" + INFURA_KEY;

      // Chainlink ETH/USD feed on Sepolia (read-only demo)
      const CHAINLINK_ETH_USD_FEED = "0x694AA1769357215DE4FAC081bf1f309aDC325306";

      const logEl = document.getElementById("log");
      const log = (...args) => {
        logEl.textContent += args.map(String).join(" ") + "\n";
      };

      // Init MetaMask SDK (CDN / pure JS style)
      // Docs show using MetaMaskSDK.MetaMaskSDK constructor. 
      const sdk = new MetaMaskSDK.MetaMaskSDK({
        dappMetadata: {
          name: "Bare MetaMask SDK Demo",
          url: window.location.href,
        },
        infuraAPIKey: INFURA_KEY,

        // Important for Android Chrome: force deeplink in same tab
        openDeeplink: (link) => {
          window.location.href = link;
        },
      });

      const ethereum = sdk.getProvider();
      let connected = false;

      async function ensureSepolia() {
        const current = await ethereum.request({ method: "eth_chainId" });
        if (current === SEPOLIA_CHAIN_ID) return;

        try {
          await ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: SEPOLIA_CHAIN_ID }],
          });
        } catch (e) {
          // If Sepolia isn't added, add it
          const msg = e && e.message ? String(e.message) : "";
          if (e && (e.code === 4902 || msg.includes("4902"))) {
            await ethereum.request({
              method: "wallet_addEthereumChain",
              params: [
                {
                  chainId: SEPOLIA_CHAIN_ID,
                  chainName: "Sepolia",
                  nativeCurrency: { name: "Sepolia ETH", symbol: "SEP", decimals: 18 },
                  rpcUrls: [SEPOLIA_RPC],
                  blockExplorerUrls: ["https://sepolia.etherscan.io"],
                },
              ],
            });
          } else {
            throw e;
          }
        }
      }

      // Small helpers to decode ABI outputs without ethers.js
      function words32(hex) {
        const clean = hex.startsWith("0x") ? hex.slice(2) : hex;
        return clean.match(/.{1,64}/g) || [];
      }
      function decodeInt256(wordHex) {
        const x = BigInt("0x" + wordHex);
        const TWO_256 = 1n << 256n;
        const TWO_255 = 1n << 255n;
        return x >= TWO_255 ? x - TWO_256 : x;
      }

      document.getElementById("connect").onclick = async () => {
        try {
          log("Connecting…");
          const accounts = await sdk.connect();
          connected = true;

          log("Accounts:", accounts);
          log("Chain:", await ethereum.request({ method: "eth_chainId" }));

          document.getElementById("call").disabled = false;
        } catch (e) {
          log("Connect error:", (e && e.message) || e);
        }
      };

      document.getElementById("call").onclick = async () => {
        try {
          if (!connected) throw new Error("Not connected");

          await ensureSepolia();
          log("On Sepolia ✅");

          // decimals() selector = 0x313ce567
          const decRaw = await ethereum.request({
            method: "eth_call",
            params: [{ to: CHAINLINK_ETH_USD_FEED, data: "0x313ce567" }, "latest"],
          });
          const decimals = Number(BigInt(decRaw));

          // latestRoundData() selector = 0xfeaf968c
          const raw = await ethereum.request({
            method: "eth_call",
            params: [{ to: CHAINLINK_ETH_USD_FEED, data: "0xfeaf968c" }, "latest"],
          });

          const w = words32(raw);
          const answer = decodeInt256(w[1]); // int256 answer
          const price = Number(answer) / Math.pow(10, decimals);

          log("ETH/USD:", price);
          log("Feed:", CHAINLINK_ETH_USD_FEED);
        } catch (e) {
          log("Call error:", (e && e.message) || e);
        }
      };
    </script>
  </body>
</html>

