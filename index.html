<!doctype html>
<html>
  <body>
    <div>
      Project ID:
      <input id="projectId" style="width:360px" value="YOUR_PROJECT_ID_HERE" />
      <button id="btnSave">Save</button>
    </div>

    <p>
      <button id="btnConnect">Connect</button>
      <button id="btnOpenMM" disabled>Open MetaMask</button>
      <button id="btnSwitch" disabled>Switch/Add Sepolia</button>
      <button id="btnBalance" disabled>Refresh Balance</button>
      <button id="btnDemoTx" disabled>Demo: Send 0.0001 Sepolia ETH to self</button>
      <button id="btnDisconnect" disabled>Disconnect</button>
    </p>

    <pre id="log"></pre>

    <div style="border:1px solid #ccc; padding:8px;">
      <div><b>Status:</b> <span id="status">idle</span></div>
      <div><b>Account:</b> <span id="acct">-</span></div>
      <div><b>Chain:</b> <span id="chain">-</span></div>
      <div><b>Balance (Sepolia ETH):</b> <span id="bal">-</span></div>
    </div>

    <!-- WalletConnect v2 EthereumProvider (UMD build, no bundler) -->
    <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.23.3/dist/index.umd.js"></script>

    <script>
      const logEl = document.getElementById("log");
      const statusEl = document.getElementById("status");
      const acctEl = document.getElementById("acct");
      const chainEl = document.getElementById("chain");
      const balEl = document.getElementById("bal");

      const btnConnect = document.getElementById("btnConnect");
      const btnOpenMM = document.getElementById("btnOpenMM");
      const btnSwitch = document.getElementById("btnSwitch");
      const btnBalance = document.getElementById("btnBalance");
      const btnDemoTx = document.getElementById("btnDemoTx");
      const btnDisconnect = document.getElementById("btnDisconnect");

      function log(...args) {
        logEl.textContent += args.map(String).join(" ") + "\n";
      }
      function setStatus(s) { statusEl.textContent = s; }

      // ---- Sepolia config ----
      const SEPOLIA_ID_DEC = 11155111;
      const SEPOLIA_ID_HEX = "0xaa36a7";
      const SEPOLIA_RPC = "https://rpc.sepolia.org";
      const SEPOLIA_EXPLORER = "https://sepolia.etherscan.io";

      // ---- State ----
      let provider = null;
      let wcUri = null;

      // Persist projectId for GitHub Pages convenience
      const projectIdInput = document.getElementById("projectId");
      const btnSave = document.getElementById("btnSave");
      const saved = localStorage.getItem("wc_project_id");
      if (saved && saved.trim()) projectIdInput.value = saved;

      btnSave.onclick = () => {
        localStorage.setItem("wc_project_id", projectIdInput.value.trim());
        log("Saved projectId to localStorage.");
      };

      function enableAfterUri(enable) {
        btnOpenMM.disabled = !enable;
      }
      function enableAfterConnect(enable) {
        btnSwitch.disabled = !enable;
        btnBalance.disabled = !enable;
        btnDemoTx.disabled = !enable;
        btnDisconnect.disabled = !enable;
      }

      async function ensureProvider() {
        if (provider) return provider;

        const pid = projectIdInput.value.trim();
        if (!pid || pid.includes("YOUR_PROJECT_ID_HERE")) {
          alert("Paste a real WalletConnect/Reown projectId first.");
          throw new Error("Missing projectId");
        }

        const WC = window["@walletconnect/ethereum-provider"];
        if (!WC?.EthereumProvider) throw new Error("WalletConnect EthereumProvider not loaded");

        provider = await WC.EthereumProvider.init({
          projectId: pid,
          showQrModal: false,
          // We'll request Sepolia capability
          optionalChains: [SEPOLIA_ID_DEC],
          rpcMap: { [SEPOLIA_ID_DEC]: SEPOLIA_RPC },
          metadata: {
            name: "Bare WC Demo",
            description: "WalletConnect v2 + MetaMask Mobile + Sepolia",
            url: location.origin,
            icons: []
          }
        });

        provider.on("display_uri", (uri) => {
          wcUri = uri;
          enableAfterUri(true);
          setStatus("pairing uri ready");
          log("display_uri ready");
        });

        provider.on("connect", (info) => {
          setStatus("connected (session established)");
          log("connected:", JSON.stringify(info));
        });

        provider.on("disconnect", () => {
          setStatus("disconnected");
          log("disconnected");
          wcUri = null;
          enableAfterUri(false);
          enableAfterConnect(false);
          acctEl.textContent = "-";
          chainEl.textContent = "-";
          balEl.textContent = "-";
        });

        provider.on("accountsChanged", (a) => {
          log("accountsChanged:", JSON.stringify(a));
          if (a && a[0]) acctEl.textContent = a[0];
        });

        provider.on("chainChanged", (c) => {
          log("chainChanged:", String(c));
          chainEl.textContent = String(c);
        });

        return provider;
      }

      function metamaskLinkForUri(uri) {
        const enc = encodeURIComponent(uri);
        const isAndroid = /Android/i.test(navigator.userAgent);
        // Android: scheme link tends to be the most direct
        // Non-Android: universal link is fine
        return isAndroid
          ? `metamask://wc?uri=${enc}`
          : `https://metamask.app.link/wc?uri=${enc}`;
      }

      async function getAccount() {
        const accounts = await provider.request({ method: "eth_accounts" });
        const acct = accounts && accounts[0] ? accounts[0] : null;
        acctEl.textContent = acct || "-";
        return acct;
      }

      async function getChainIdHex() {
        const chainIdHex = await provider.request({ method: "eth_chainId" });
        chainEl.textContent = chainIdHex;
        return chainIdHex;
      }

      async function switchOrAddSepolia() {
        setStatus("switching/adding sepolia...");
        const chainIdHex = await getChainIdHex();

        if (chainIdHex && chainIdHex.toLowerCase() === SEPOLIA_ID_HEX) {
          setStatus("already on sepolia");
          return;
        }

        try {
          await provider.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: SEPOLIA_ID_HEX }]
          });
          setStatus("switched to sepolia");
          return;
        } catch (e) {
          // 4902 = unknown chain in many wallets
          const code = e?.code ?? e?.data?.originalError?.code;
          log("wallet_switchEthereumChain error:", (e?.message || e), "code:", String(code));

          if (code === 4902 || (String(e?.message || "").includes("4902"))) {
            log("Sepolia not found in wallet. Adding it...");
            await provider.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: SEPOLIA_ID_HEX,
                chainName: "Sepolia",
                nativeCurrency: { name: "Sepolia ETH", symbol: "ETH", decimals: 18 },
                rpcUrls: [SEPOLIA_RPC],
                blockExplorerUrls: [SEPOLIA_EXPLORER]
              }]
            });
            setStatus("sepolia added (wallet may also switch)");
            // Try switching again just in case wallet didn't auto-switch
            await provider.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: SEPOLIA_ID_HEX }]
            });
            setStatus("switched to sepolia");
            return;
          }

          setStatus("switch failed (see logs)");
          throw e;
        }
      }

      function formatEthFromWeiHex(weiHex) {
        // weiHex like "0x123..."
        const wei = BigInt(weiHex);
        const whole = wei / 1000000000000000000n;
        const frac = wei % 1000000000000000000n;
        // show 6 decimals
        const fracStr = frac.toString().padStart(18, "0").slice(0, 6);
        return `${whole.toString()}.${fracStr}`;
      }

      async function refreshBalance() {
        setStatus("fetching balance...");
        const acct = await getAccount();
        if (!acct) {
          setStatus("no account yet");
          return;
        }

        const chainIdHex = await getChainIdHex();
        if (chainIdHex.toLowerCase() !== SEPOLIA_ID_HEX) {
          setStatus("not on sepolia (switch first)");
          return;
        }

        const balHex = await provider.request({
          method: "eth_getBalance",
          params: [acct, "latest"]
        });

        balEl.textContent = formatEthFromWeiHex(balHex);
        setStatus("balance updated");
      }

      async function demoSendToSelf() {
        setStatus("prepping demo tx...");
        const acct = await getAccount();
        if (!acct) {
          setStatus("no account yet");
          return;
        }

        const chainIdHex = await getChainIdHex();
        if (chainIdHex.toLowerCase() !== SEPOLIA_ID_HEX) {
          setStatus("not on sepolia (switch first)");
          return;
        }

        // 0.0001 ETH in wei
        const valueWei = 100000000000000n; // 1e14
        const valueHex = "0x" + valueWei.toString(16);

        setStatus("MetaMask should prompt for tx approval...");
        log("Sending demo tx to self:", acct, "value:", valueHex);

        const txHash = await provider.request({
          method: "eth_sendTransaction",
          params: [{
            from: acct,
            to: acct,
            value: valueHex
          }]
        });

        log("txHash:", txHash);
        setStatus("tx submitted (see logs)");
      }

      btnConnect.onclick = async () => {
        try {
          await ensureProvider();
          setStatus("starting connection (wait for display_uri)");
          log("Starting connection. Tap 'Open MetaMask' -> approve -> return here.");

          // Triggers display_uri; resolves after wallet approval
          await provider.connect();

          enableAfterConnect(true);
          setStatus("connected (now switch to sepolia)");
          await getAccount();
          await getChainIdHex();
        } catch (e) {
          log("connect error:", e?.message || e);
          setStatus("connect failed (see logs)");
        }
      };

      btnOpenMM.onclick = () => {
        if (!wcUri) return;
        const target = metamaskLinkForUri(wcUri);
        log("Opening MetaMask via:", target);
        setStatus("opening MetaMask...");
        // Must be user-gesture (this is button click)
        location.href = target;
      };

      btnSwitch.onclick = async () => {
        try {
          await switchOrAddSepolia();
          await refreshBalance();
        } catch (e) {
          log("switch/add error:", e?.message || e);
          setStatus("switch/add failed (see logs)");
        }
      };

      btnBalance.onclick = async () => {
        try {
          await refreshBalance();
        } catch (e) {
          log("balance error:", e?.message || e);
          setStatus("balance failed (see logs)");
        }
      };

      btnDemoTx.onclick = async () => {
        try {
          await demoSendToSelf();
        } catch (e) {
          log("demo tx error:", e?.message || e);
          setStatus("demo tx failed (see logs)");
        }
      };

      btnDisconnect.onclick = async () => {
        try {
          if (!provider) return;
          await provider.disconnect();
        } catch (e) {
          log("disconnect error:", e?.message || e);
          setStatus("disconnect failed (see logs)");
        }
      };

      // Initial UI
      enableAfterUri(false);
      enableAfterConnect(false);
      setStatus("idle");
    </script>
  </body>
</html>






