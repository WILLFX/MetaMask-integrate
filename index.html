<!doctype html>
<html>
  <body>
    <h3>WC v2 + MetaMask (Android Chrome) | Sepolia demo</h3>

    <div>
      <label>
        Project ID:
        <input id="projectId" style="width:360px" placeholder="paste Reown/WC projectId" />
      </label>
      <button id="btnSave">Save</button>
    </div>

    <p>
      <button id="btnConnect">Connect</button>
      <button id="btnOpenMM" disabled>Open MetaMask</button>
      <button id="btnRefresh" disabled>Refresh (accounts/balance)</button>
      <button id="btnSendTiny" disabled>Send tiny tx (optional)</button>
      <button id="btnDisconnect" disabled>Disconnect</button>
    </p>

    <pre id="log" style="white-space: pre-wrap; border:1px solid #444; padding:10px;"></pre>

    <!-- WalletConnect v2 EthereumProvider (UMD build, no bundler) -->
    <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.23.3/dist/index.umd.js"></script>

    <script>
      const logEl = document.getElementById("log");
      const btnConnect = document.getElementById("btnConnect");
      const btnOpenMM = document.getElementById("btnOpenMM");
      const btnRefresh = document.getElementById("btnRefresh");
      const btnSendTiny = document.getElementById("btnSendTiny");
      const btnDisconnect = document.getElementById("btnDisconnect");
      const projectIdInput = document.getElementById("projectId");

      function log(...args) {
        logEl.textContent += args.map(String).join(" ") + "\n";
      }

      // ---- Sepolia constants ----
      const SEPOLIA_DEC = 11155111;                 // chainId decimal
      const SEPOLIA_HEX = "0xaa36a7";               // chainId hex :contentReference[oaicite:1]{index=1}
      const SEPOLIA_RPC = "https://rpc.sepolia.org"; // public RPC :contentReference[oaicite:2]{index=2}

      // ---- state ----
      let provider = null;
      let wcUri = null;
      let connectPromise = null;

      function isAndroid() {
        return /Android/i.test(navigator.userAgent || "");
      }

      function formatEthFromWeiHex(hexWei) {
        const wei = BigInt(hexWei);
        const ETH = 10n ** 18n;
        const whole = wei / ETH;
        const frac = wei % ETH;
        // show up to 6 decimals without floating point
        const fracStr = (frac + ETH).toString().slice(1).slice(0, 6).replace(/0+$/, "");
        return fracStr ? `${whole}.${fracStr}` : `${whole}`;
      }

      function loadProjectId() {
        const saved = localStorage.getItem("wc_projectId") || "";
        projectIdInput.value = saved;
      }

      function saveProjectId() {
        const v = projectIdInput.value.trim();
        localStorage.setItem("wc_projectId", v);
        log("Saved projectId.");
      }

      async function ensureProvider() {
        if (provider) return provider;

        const WC = window["@walletconnect/ethereum-provider"];
        if (!WC?.EthereumProvider) throw new Error("WalletConnect EthereumProvider not loaded");

        const projectId = projectIdInput.value.trim();
        if (!projectId) throw new Error("Missing projectId (paste it first)");

        provider = await WC.EthereumProvider.init({
          projectId,
          showQrModal: false,

          metadata: {
            name: "Bare WC Sepolia Demo",
            description: "index.html WC v2 demo (Android Chrome + MetaMask)",
            url: location.origin,
            icons: []
          },

          // We’ll use Sepolia for the demo call
          optionalChains: [SEPOLIA_DEC],
          rpcMap: { [SEPOLIA_DEC]: SEPOLIA_RPC }
        });

        provider.on("display_uri", (uri) => {
          wcUri = uri;
          log("display_uri ready");
          btnOpenMM.disabled = false;
        });

        provider.on("connect", (info) => {
          log("provider connect event:", JSON.stringify(info));
        });

        provider.on("disconnect", (err) => {
          log("disconnected", err?.message || "");
          wcUri = null;
          btnOpenMM.disabled = true;
          btnRefresh.disabled = true;
          btnSendTiny.disabled = true;
          btnDisconnect.disabled = true;
        });

        provider.on("accountsChanged", (a) => log("accountsChanged:", JSON.stringify(a)));
        provider.on("chainChanged", (c) => log("chainChanged:", String(c)));

        return provider;
      }

      function openMetaMask() {
        if (!wcUri) return;

        const enc = encodeURIComponent(wcUri);

        // Android: scheme link is often the most reliable
        const schemeLink = `metamask://wc?uri=${enc}`;

        // Others: universal link is fine
        const universalLink = `https://metamask.app.link/wc?uri=${enc}`;

        const target = isAndroid() ? schemeLink : universalLink;
        log("Opening MetaMask via:", target);
        location.href = target;
      }

      async function switchToSepolia() {
        try {
          await provider.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: SEPOLIA_HEX }]
          });
          return true;
        } catch (e) {
          // Some wallets require adding the chain first (rare for Sepolia in MetaMask)
          // We try add as fallback.
          try {
            await provider.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: SEPOLIA_HEX,
                chainName: "Sepolia",
                nativeCurrency: { name: "SepoliaETH", symbol: "ETH", decimals: 18 },
                rpcUrls: [SEPOLIA_RPC],
                blockExplorerUrls: ["https://sepolia.etherscan.io"]
              }]
            });
            return true;
          } catch (e2) {
            log("Could not switch/add Sepolia:", e2?.message || e2);
            log("Tip: switch to Sepolia manually in MetaMask, then hit Refresh.");
            return false;
          }
        }
      }

      async function refreshAccountsAndBalance() {
        const accounts = await provider.request({ method: "eth_accounts" });
        const addr = accounts?.[0];
        if (!addr) {
          log("No account yet. Make sure you approved connection in MetaMask.");
          return;
        }

        const chainIdHex = await provider.request({ method: "eth_chainId" });
        log("Account:", addr);
        log("ChainId:", chainIdHex);

        // Demo call on Sepolia: get balance
        const balHex = await provider.request({
          method: "eth_getBalance",
          params: [addr, "latest"]
        });

        log("Balance (wei hex):", balHex);
        log("Balance (ETH):", formatEthFromWeiHex(balHex));
      }

      async function sendTinyTx() {
        const accounts = await provider.request({ method: "eth_accounts" });
        const from = accounts?.[0];
        if (!from) return log("No account. Connect first.");

        // 0.00001 ETH in wei = 10^13 wei = 0x2386F26FC10000
        // Needs Sepolia ETH for gas. If you have none, MetaMask will fail the send.
        const valueHex = "0x2386f26fc10000";

        const txHash = await provider.request({
          method: "eth_sendTransaction",
          params: [{
            from,
            to: from,          // send to self for a harmless demo
            value: valueHex
          }]
        });

        log("Sent tx:", txHash);
      }

      btnSave.onclick = saveProjectId;

      btnConnect.onclick = async () => {
        try {
          await ensureProvider();

          log("Starting connection...");
          log("Tap 'Open MetaMask' -> approve -> return here.");

          // Start connect but don’t block UI
          connectPromise = provider.connect();

          connectPromise.then(async () => {
            log("Approved ✅");
            btnRefresh.disabled = false;
            btnSendTiny.disabled = false;
            btnDisconnect.disabled = false;

            // Switch to Sepolia then run the demo call
            await switchToSepolia();
            await refreshAccountsAndBalance();
          }).catch((e) => {
            log("connect failed:", e?.message || e);
          });

        } catch (e) {
          log("Connect error:", e?.message || e);
        }
      };

      btnOpenMM.onclick = openMetaMask;
      btnRefresh.onclick = async () => {
        await switchToSepolia();
        await refreshAccountsAndBalance();
      };
      btnSendTiny.onclick = async () => {
        try {
          await switchToSepolia();
          await sendTinyTx();
        } catch (e) {
          log("send error:", e?.message || e);
        }
      };
      btnDisconnect.onclick = async () => {
        try {
          await provider.disconnect();
        } catch (e) {
          log("disconnect error:", e?.message || e);
        }
      };

      loadProjectId();
      log("Ready.");
      log("If MetaMask approval doesn’t appear, ensure MetaMask is unlocked and any in-app lock is off during testing.");
    </script>
  </body>
</html>





