<!doctype html>
<html>
  <body>
    <button id="btnConnect">Connect</button>
    <button id="btnOpenMM" disabled>Open MetaMask</button>
    <button id="btnBalance" disabled>Switch to Sepolia + Show Balance</button>
    <button id="btnDisconnect" disabled>Disconnect</button>

    <pre id="log"></pre>

    <!-- WalletConnect v2 EthereumProvider (UMD build, no bundler) -->
    <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.23.3/dist/index.umd.js"></script>

    <script>
      const logEl = document.getElementById("log");
      const btnConnect = document.getElementById("btnConnect");
      const btnOpenMM = document.getElementById("btnOpenMM");
      const btnBalance = document.getElementById("btnBalance");
      const btnDisconnect = document.getElementById("btnDisconnect");

      function log(...args) {
        logEl.textContent += args.map(String).join(" ") + "\n";
      }

      // ---- CONFIG ----
      const projectId = "YOUR_PROJECT_ID_HERE";

      // Sepolia
      const SEPOLIA_CHAIN_ID_DEC = 11155111;
      const SEPOLIA_CHAIN_ID_HEX = "0xaa36a7"; // 11155111 in hex
      const SEPOLIA_RPC = "https://rpc.sepolia.org";
      const SEPOLIA_EXPLORER = "https://sepolia.etherscan.io";

      // ---- STATE ----
      let provider = null;
      let wcUri = null;

      function isAndroid() {
        return /Android/i.test(navigator.userAgent);
      }

      function formatEth(weiBig) {
        // Minimal ETH formatting without dependencies.
        // Shows up to 6 decimal places.
        const WEI_PER_ETH = 1000000000000000000n;
        const whole = weiBig / WEI_PER_ETH;
        const frac = weiBig % WEI_PER_ETH;

        // Take first 6 decimals from the 18-decimal fraction
        const fracStr = frac.toString().padStart(18, "0").slice(0, 6);
        return `${whole.toString()}.${fracStr}`;
      }

      async function ensureProvider() {
        if (provider) return provider;

        const WC = window["@walletconnect/ethereum-provider"];
        if (!WC?.EthereumProvider) throw new Error("WalletConnect EthereumProvider not loaded");

        provider = await WC.EthereumProvider.init({
          projectId,
          showQrModal: false,
          metadata: {
            name: "Bare WC Demo",
            description: "WalletConnect v2 bare HTML (Chrome + MetaMask Mobile)",
            url: location.origin,
            icons: ["https://metamask.io/images/favicon-32.png"]
          },
          optionalChains: [SEPOLIA_CHAIN_ID_DEC],
          rpcMap: { [SEPOLIA_CHAIN_ID_DEC]: SEPOLIA_RPC }
        });

        provider.on("display_uri", (uri) => {
          wcUri = uri;
          log("display_uri ready");
          btnOpenMM.disabled = false;
        });

        provider.on("connect", (info) => {
          log("connected:", JSON.stringify(info));
          btnDisconnect.disabled = false;
          btnBalance.disabled = false;
        });

        provider.on("disconnect", () => {
          log("disconnected");
          wcUri = null;
          btnOpenMM.disabled = true;
          btnDisconnect.disabled = true;
          btnBalance.disabled = true;
        });

        provider.on("accountsChanged", (accounts) => {
          log("accountsChanged:", JSON.stringify(accounts));
          if (accounts?.[0]) log("account:", accounts[0]);
        });

        provider.on("chainChanged", (chainId) => {
          // chainId might come as hex string
          log("chainChanged:", String(chainId));
        });

        return provider;
      }

      async function getFirstAccount() {
        const accounts = await provider.request({ method: "eth_accounts" });
        return accounts?.[0] || null;
      }

      async function switchToSepolia() {
        // Try switch; if chain not added, add then switch.
        try {
          await provider.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: SEPOLIA_CHAIN_ID_HEX }]
          });
          log("Switched to Sepolia.");
          return true;
        } catch (e) {
          const msg = e?.message || String(e);
          const code = e?.code;

          // 4902 is common "unknown chain" code in wallets
          if (code === 4902 || msg.includes("4902")) {
            log("Sepolia not added. Adding chain...");
            await provider.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: SEPOLIA_CHAIN_ID_HEX,
                chainName: "Sepolia",
                nativeCurrency: { name: "SepoliaETH", symbol: "ETH", decimals: 18 },
                rpcUrls: [SEPOLIA_RPC],
                blockExplorerUrls: [SEPOLIA_EXPLORER]
              }]
            });

            // After adding, switch again
            await provider.request({
              method: "wallet_switchEthereumChain",
              params: [{ chainId: SEPOLIA_CHAIN_ID_HEX }]
            });
            log("Added + switched to Sepolia.");
            return true;
          }

          log("Switch error:", msg);
          return false;
        }
      }

      async function showSepoliaBalance() {
        const acct = await getFirstAccount();
        if (!acct) {
          log("No account. Connect first.");
          return;
        }

        const switched = await switchToSepolia();
        if (!switched) {
          log("Could not switch to Sepolia. Try switching manually in MetaMask, then press balance again.");
          return;
        }

        // Fetch balance (hex wei)
        const balHex = await provider.request({
          method: "eth_getBalance",
          params: [acct, "latest"]
        });

        const wei = BigInt(balHex);
        log("Sepolia balance for", acct, "=", formatEth(wei), "ETH");
      }

      btnConnect.onclick = async () => {
        try {
          await ensureProvider();
          log("Starting connection. Tap 'Open MetaMask' -> approve -> return here.");

          // Resolves after wallet approval
          await provider.connect();

          const acct = await getFirstAccount();
          log("account:", acct || "(none yet)");

          // Auto-switch attempt after connect (quietly)
          if (acct) {
            await showSepoliaBalance();
          }

          btnDisconnect.disabled = false;
          btnBalance.disabled = false;
        } catch (e) {
          log("connect error:", e?.message || e);
        }
      };

      btnOpenMM.onclick = () => {
        if (!wcUri) return;

        const uri = encodeURIComponent(wcUri);
        // Android: prefer scheme link (often preserves wc params better)
        const schemeLink = `metamask://wc?uri=${uri}`;
        // Non-Android: universal link is usually fine
        const universalLink = `https://metamask.app.link/wc?uri=${uri}`;
        const target = isAndroid() ? schemeLink : universalLink;

        log("Opening MetaMask via:", target);
        location.href = target;
      };

      btnBalance.onclick = async () => {
        try {
          if (!provider) await ensureProvider();
          await showSepoliaBalance();
        } catch (e) {
          log("balance error:", e?.message || e);
        }
      };

      btnDisconnect.onclick = async () => {
        try {
          if (!provider) return;
          await provider.disconnect();
        } catch (e) {
          log("disconnect error:", e?.message || e);
        }
      };

      // Try restore session on reload
      (async () => {
        try {
          await ensureProvider();
          const acct = await getFirstAccount();
          if (acct) {
            log("restored account:", acct);
            btnDisconnect.disabled = false;
            btnBalance.disabled = false;
          }
        } catch (_) {}
      })();
    </script>
  </body>
</html>






